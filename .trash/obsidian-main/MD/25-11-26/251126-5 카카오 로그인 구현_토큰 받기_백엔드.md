좋습니다! 오늘 진행한 카카오 로그인 구현 과정을 정리하겠습니다.

---

## 🎯 오늘 구현한 것: 카카오 소셜 로그인 (백엔드)

### 📌 목표
프론트엔드(Next.js)에서 카카오 로그인 버튼을 누르면, 백엔드(Spring Boot)가 카카오 인증을 처리하고 JWT 토큰을 발급하는 시스템 구축

---

## 🔧 1단계: 환경 설정

### 1-1. 환경 변수 설정 (`.env` 파일)
프로젝트 루트에 `.env` 파일 생성:
```env
KAKAO_REST_API_KEY=카카오_REST_API_키
KAKAO_REDIRECT_URI=http://localhost:8080/api/auth/kakao/callback
JWT_SECRET=최소_32자_이상의_랜덤_문자열
```

### 1-2. Docker Compose 설정
`docker-compose.yaml`에 환경 변수 전달:
```yaml
authservice:
  environment:
    - KAKAO_REST_API_KEY=${KAKAO_REST_API_KEY}
    - KAKAO_REDIRECT_URI=${KAKAO_REDIRECT_URI}
    - JWT_SECRET=${JWT_SECRET}
```

### 1-3. Spring Boot 설정
`application.yaml`에 환경 변수 매핑:
```yaml
kakao:
  rest-api-key: ${KAKAO_REST_API_KEY}
  redirect-uri: ${KAKAO_REDIRECT_URI}

jwt:
  secret: ${JWT_SECRET}
  expiration: 86400000  # 24시간
```

---

## 🛠️ 2단계: JWT 토큰 생성 기능 구현

### 2-1. JWT 의존성 추가
`build.gradle`에 JWT 라이브러리 추가:
```gradle
implementation 'io.jsonwebtoken:jjwt-api:0.12.3'
runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.3'
runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.3'
```

### 2-2. JWT 토큰 생성/검증 클래스
`JwtTokenProvider.java` 생성:
- **역할**: 사용자 정보를 받아서 JWT 토큰 생성
- **주요 메서드**:
  - `generateToken()` - JWT 생성
  - `validateToken()` - JWT 검증
  - `extractClaims()` - JWT에서 사용자 정보 추출

---

## 🌐 3단계: 카카오 API 통신 구현

### 3-1. RestTemplate 설정
`RestTemplateConfig.java` 생성:
- **역할**: HTTP 요청을 보내기 위한 도구 설정

### 3-2. 카카오 API 통신 서비스
`KakaoService.java` 생성:
- **역할**: 카카오 서버와 통신
- **주요 메서드**:
  1. `generateAuthUrl()` - 카카오 로그인 URL 생성
  2. `getAccessToken()` - 인가 코드로 카카오 액세스 토큰 요청
  3. `getUserInfo()` - 액세스 토큰으로 사용자 정보 조회

### 3-3. DTO 클래스
- `KakaoTokenResponse.java` - 카카오 토큰 응답 매핑
- `KakaoUserInfo.java` - 카카오 사용자 정보 매핑

---

## 🎮 4단계: 컨트롤러 구현

### 4-1. 카카오 로그인 엔드포인트
`KakaoController.java` 생성:

**① GET /api/auth/kakao/auth-url**
- **역할**: 카카오 로그인 URL 생성
- **응답**: `{ "authUrl": "https://kauth.kakao.com/oauth/authorize?..." }`
- **프론트엔드**: 이 URL로 사용자를 리다이렉트

**② POST /api/auth/kakao/login**
- **역할**: 인가 코드로 로그인 처리
- **요청**: `{ "code": "카카오_인가_코드" }`
- **응답**: `{ "token": "JWT_토큰", "user": {...} }`

**③ GET /api/auth/kakao/callback**
- **역할**: 카카오에서 리다이렉트된 요청 처리
- **요청**: `?code=카카오_인가_코드`
- **응답**: `{ "token": "JWT_토큰", "user": {...} }`

---

## 🔄 5단계: 전체 플로우

```
1. 사용자가 "카카오 로그인" 버튼 클릭
   ↓
2. 프론트엔드: GET /api/auth/kakao/auth-url 호출
   ↓
3. 백엔드: 카카오 로그인 URL 반환
   ↓
4. 프론트엔드: 사용자를 카카오 로그인 페이지로 리다이렉트
   ↓
5. 사용자가 카카오에서 로그인
   ↓
6. 카카오: 백엔드로 리다이렉트 (code 전달)
   http://localhost:8080/api/auth/kakao/callback?code=xxx
   ↓
7. 백엔드: 
   - code로 카카오 액세스 토큰 요청
   - 액세스 토큰으로 사용자 정보 조회
   - 사용자 정보로 JWT 토큰 생성
   ↓
8. 백엔드: JWT 토큰 + 사용자 정보 반환
   { "token": "JWT_토큰", "user": {...} }
   ↓
9. 프론트엔드: JWT 토큰 저장 → 로그인 완료!
```

---

## 🐛 해결한 주요 문제들

### 문제 1: JWT 라이브러리 버전 오류
- **오류**: `parserBuilder()` 메서드를 찾을 수 없음
- **원인**: jjwt 0.12.x 버전에서 API 변경
- **해결**: `parserBuilder()` → `parser()`, `parseClaimsJws()` → `parseSignedClaims()`

### 문제 2: 카카오 Redirect URI 불일치
- **오류**: "웹 관리자 설정 오류 (KOE004)"
- **원인**: 카카오 개발자 콘솔에 Redirect URI 미등록
- **해결**: `http://localhost:8080/api/auth/kakao/callback` 등록

### 문제 3: 404 Not Found
- **오류**: `/oauth2/kakao/callback` 경로를 찾을 수 없음
- **원인**: Gateway 라우팅과 Redirect URI 불일치
- **해결**: Redirect URI를 `/api/auth/kakao/callback`으로 통일

---

## 📁 생성된 파일 목록

```
services/authservice/src/main/java/com/elianayesol/api/
├── jwt/
│   └── JwtTokenProvider.java          # JWT 토큰 생성/검증
├── config/
│   └── RestTemplateConfig.java        # HTTP 클라이언트 설정
├── kakao/
│   ├── KakaoController.java           # 카카오 로그인 엔드포인트
│   ├── KakaoService.java              # 카카오 API 통신
│   └── dto/
│       ├── KakaoTokenResponse.java    # 카카오 토큰 응답 DTO
│       └── KakaoUserInfo.java         # 카카오 사용자 정보 DTO
```

---

## ✅ 최종 결과

- ✅ 카카오 로그인 URL 생성 기능
- ✅ 카카오 OAuth 인증 처리
- ✅ JWT 토큰 발급
- ✅ 사용자 정보 조회
- ✅ API 키 보안 (프론트엔드에 노출 안 됨)

---

## 🚀 다음 단계 (향후 작업)

1. **Google, Naver 로그인 추가** - 동일한 구조로 확장 가능
2. **DB 연동** - 사용자 정보 저장 (현재는 DB 없이 JWT만 발급)
3. **Refresh Token** - 장기 로그인 유지
4. **프론트엔드 완성** - 토큰 저장 및 인증 상태 관리

---

오늘은 **백엔드 카카오 로그인 인증 + JWT 토큰 발급**까지 완료했습니다! 🎉